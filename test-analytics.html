<!DOCTYPE html>
<html>
<head>
    <title>Analytics Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: Arial; }
        .test-chart { width: 400px; height: 200px; margin: 20px; background: #333; border-radius: 10px; padding: 20px; }
        canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body>
    <h1>Analytics Test Page</h1>
    <div class="test-chart">
        <h3>Sleep Bar Chart</h3>
        <canvas id="sleepBarChart"></canvas>
    </div>
    <div class="test-chart">
        <h3>Activity Circle</h3>
        <canvas id="activityCircle"></canvas>
    </div>
    <div class="test-chart">
        <h3>Daily Productivity</h3>
        <canvas id="dailyProductivityChart"></canvas>
    </div>
    <div class="test-chart">
        <h3>Productivity Trends</h3>
        <canvas id="productivityTrendsChart"></canvas>
    </div>

    <script type="module">
        // Import Firebase modules first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import {
          getFirestore, doc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCYyTIYCX5bvN7r0BcJvLOKEON1nUaFnQk",
          authDomain: "self-improvement-7c7f6.firebaseapp.com",
          projectId: "self-improvement-7c7f6",
          storageBucket: "self-improvement-7c7f6.firebasestorage.app",
          messagingSenderId: "494829137683",
          appId: "1:494829137683:web:1e9e6f4a910b02b70774e6",
          measurementId: "G-43X839WMSM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Helper functions
        function todayId(date = new Date()) {
          const y = date.getFullYear();
          const m = String(date.getMonth()+1).padStart(2,"0");
          const d = String(date.getDate()).padStart(2,"0");
          return `${y}-${m}-${d}`;
        }

        async function getDay(dateKey = todayId()) {
          try {
            const dayDoc = doc(db, 'days', dateKey);
            const snap = await getDoc(dayDoc);
            return snap.exists() ? snap.data() : null;
          } catch (error) {
            console.error('Error fetching day data:', error);
            return null;
          }
        }

        // Test function
        async function testAnalytics() {
            console.log("ðŸ§ª Testing analytics functions...");
            
            try {
                // Test sleep data
                const sleepData = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const key = todayId(d);
                    
                    const dayData = await getDay(key);
                    const sleepMinutes = dayData?.sleep?.minutes || Math.floor(Math.random() * 480) + 360; // Random for demo
                    const sleepHours = sleepMinutes > 0 ? (sleepMinutes / 60).toFixed(1) : 0;
                    
                    sleepData.push({
                        date: key,
                        hours: parseFloat(sleepHours),
                        label: d.toLocaleDateString('en-US', { weekday: 'short' })
                    });
                }
                
                // Create sleep chart
                const sleepCanvas = document.getElementById("sleepBarChart");
                const sleepCtx = sleepCanvas.getContext("2d");
                new Chart(sleepCtx, {
                    type: "bar",
                    data: {
                        labels: sleepData.map(d => d.label),
                        datasets: [{
                            label: "Sleep Hours",
                            data: sleepData.map(d => d.hours),
                            backgroundColor: "rgba(33, 150, 243, 0.7)",
                            borderColor: "#2196f3",
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: "#cccccc" } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: "Hours", color: "#cccccc" },
                                ticks: { color: "#888" },
                                grid: { color: "rgba(255, 255, 255, 0.1)" }
                            },
                            x: {
                                ticks: { color: "#888" },
                                grid: { color: "rgba(255, 255, 255, 0.1)" }
                            }
                        }
                    }
                });

                // Test today's productivity
                const todayData = await getDay();
                let productive = 0, neutral = 0, waste = 0;
                
                if (todayData?.activities) {
                    todayData.activities.forEach(activity => {
                        const minutes = activity.minutes || 0;
                        const category = (activity.category || "neutral").toLowerCase();
                        
                        if (category === "productive") productive += minutes;
                        else if (category === "waste") waste += minutes;
                        else neutral += minutes;
                    });
                } else {
                    // Demo data if no real data
                    productive = 180; neutral = 240; waste = 60;
                }

                // Create activity pie chart
                const activityCanvas = document.getElementById("activityCircle");
                const activityCtx = activityCanvas.getContext("2d");
                new Chart(activityCtx, {
                    type: "doughnut",
                    data: {
                        labels: ["Productive", "Neutral", "Waste"],
                        datasets: [{
                            data: [productive, neutral, waste],
                            backgroundColor: ["#4caf50", "#9e9e9e", "#f44336"],
                            borderColor: "#1a1a1a",
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                                labels: { color: "#cccccc" }
                            }
                        }
                    }
                });

                console.log("âœ… Analytics test completed successfully!");
                
            } catch (error) {
                console.error("ðŸ’¥ Analytics test error:", error);
            }
        }

        // Run test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(testAnalytics, 1000);
        });
    </script>
</body>
</html>